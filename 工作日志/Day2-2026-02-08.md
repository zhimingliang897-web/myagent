# Day 2 — 2026-02-08 — 加入 RAG（检索增强生成）

## 今日目标

让 Agent 能够加载本地文档，建立向量索引，并基于文档内容回答用户问题。

## 完成内容

### 1. 新增依赖
- [x] `faiss-cpu` — 本地向量搜索引擎
- [x] `langchain-text-splitters` — 文档分块（随 langchain 自动安装）
- [x] DashScope `text-embedding-v3` — 1024 维 embedding 模型（使用同一个 API key）

### 2. RAG 子包 (`agent/rag/`)
- [x] `agent/rag/__init__.py` — 包标记
- [x] `agent/rag/loader.py` — 文档加载器
  - 支持 `.txt`、`.md`、`.pdf` 三种格式
  - 支持加载单个文件或递归扫描整个目录
  - PDF 使用 `PyPDFLoader`（按需安装 `pypdf`）
- [x] `agent/rag/vectorstore.py` — 向量存储管理
  - `split_documents()` — 用 `RecursiveCharacterTextSplitter` 分块（500 字符/块，100 重叠）
  - 分隔符优先级：段落 > 换行 > 中文句号 > 英文标点 > 空格
  - `build_vectorstore()` — 调用 DashScope embedding → FAISS 索引 → 持久化到 `vectorstore/`
  - `load_vectorstore()` — 从磁盘加载已有索引
- [x] `agent/rag/retriever.py` — RAG 工具封装
  - 将 FAISS retriever 包装为 `@tool` 装饰的 `knowledge_search` 函数
  - Agent 可自主判断何时调用知识库检索
  - 返回 top-4 相关片段，附带来源文件名
  - 如果向量索引不存在，返回 `None`（优雅降级，不影响 Agent 启动）

### 3. 索引脚本
- [x] `scripts/index_docs.py` — 一键索引命令行脚本
  - 用法：`python scripts/index_docs.py <文档路径>`
  - 三步流程：加载 → 分块 → 向量化

### 4. 集成到 Agent
- [x] `main.py` 更新
  - 启动时自动检测向量索引是否存在
  - 存在则加载 `knowledge_search` 工具，否则跳过
  - 系统提示词增加知识库搜索规则：优先查文档、注明来源

### 5. 测试文档
- [x] `data/项目介绍.md` — MyAgent 项目介绍文档
- [x] `data/Python知识笔记.txt` — Python 装饰器/生成器/上下文管理器笔记

### 6. 其他
- [x] `requirements.txt` 更新 — 新增 `faiss-cpu`、`langchain-text-splitters`
- [x] `.gitignore` 已包含 `vectorstore/`（Day 1 已添加）

## 测试结果

- ✅ DashScope embedding 连接正常，维度 1024
- ✅ 索引脚本：2 个文档 → 6 个片段，向量存储保存成功
- ✅ RAG 工具加载正常
- ✅ 端到端测试通过：
  - 问 "MyAgent项目使用了什么技术栈？"
  - Agent 调用 `knowledge_search` 检索到项目介绍文档
  - 返回完整准确的技术栈信息（LLM、框架、向量数据库、Embedding 模型等）

## 最终项目结构

```
e:\MyAgent\
├── .env
├── .gitignore
├── requirements.txt
├── test.py
├── main.py
├── agent/
│   ├── __init__.py
│   ├── callbacks.py          ← Day 1 后用户自行添加
│   ├── config.py
│   ├── llm.py
│   ├── tools.py
│   └── rag/                  ← Day 2 新增
│       ├── __init__.py
│       ├── loader.py
│       ├── vectorstore.py
│       └── retriever.py
├── data/                     ← Day 2 新增
│   ├── 项目介绍.md
│   └── Python知识笔记.txt
├── scripts/                  ← Day 2 新增
│   └── index_docs.py
├── vectorstore/              ← 运行索引后生成（已 gitignore）
└── 工作日志/
    ├── 整体计划.md
    ├── Day1-2026-02-07.md
    └── Day2-2026-02-08.md
```

## 学到的东西

- `conda run` 在 Windows 上有中文编码问题（UnicodeEncodeError: 'gbk'），直接用 conda 环境的 Python 路径更可靠
- DashScope 的 `DashScopeEmbeddings` 在 `langchain_community.embeddings` 中，API key 参数名为 `dashscope_api_key`
- FAISS `load_local` 需要 `allow_dangerous_deserialization=True` 参数

## 下一步

Phase 3 — 加入 Memory（对话记忆持久化）
