# Day 3 — 2026-02-09 — Phase 3: Memory + Token 优化

## 今日目标

实现持久化对话记忆，支持跨会话记住上下文，并优化 token 消耗。

## 完成内容

### 1. Memory 模块 (Phase 3)

- [x] **新增依赖**: `langgraph-checkpoint-sqlite`
- [x] **Memory 子包** (`agent/memory/`)
  - `checkpointer.py` — 创建 `SqliteSaver` 检查点管理器
  - 数据库路径: `data/db/agent_memory.db`（专门文件夹组织）
  - 自动创建目录和数据库文件
- [x] **集成到 main.py**
  - 初始化 `checkpointer` 并传入 `create_react_agent`
  - 使用 `thread_id` 管理会话（默认 "default"）
  - 支持 `/thread <id>` 命令切换会话线程
  - `clear` 命令现在生成新 thread_id 实现清空效果

### 2. 数据库管理

- [x] **数据库组织**
  - 创建 `data/db/` 目录统一存放数据库文件
  - 添加 `.gitkeep` 占位文件
- [x] **检查脚本** (`scripts/inspect_db.py`)
  - 列出所有表和行数
  - 可选查看最近 5 条 checkpoint 详情
  - 自动计算项目根目录相对路径，避免转义问题
  - 用法: `python scripts/inspect_db.py [db_path]`

### 3. Token 优化

- [x] **消息窗口限制**
  - 实现 `trim_message_history()` 状态修改器
  - 只保留最近 `MAX_MESSAGES` (默认10) 条消息
  - 系统消息始终保留
  - 使用 `state_modifier` 参数传入 `create_react_agent`
- [x] **效果**
  - 短对话: 无影响
  - 长对话 (20+ 轮): token 消耗减少 50-80%
  - 历史记录仍完整存储在数据库中

## 测试结果

- ✅ Memory 持久化工作正常
- ✅ 跨会话记忆测试通过
- ✅ Thread 切换功能正常
- ✅ Token 统计显示消息窗口限制有效
- ✅ 数据库检查脚本运行正常

## 最终项目结构

```
e:\MyAgent\
├── agent/
│   ├── rag/
│   └── memory/              ← Day 3 新增
│       ├── __init__.py
│       └── checkpointer.py
├── data/
│   └── db/                  ← Day 3 新增
│       └── agent_memory.db  (运行后生成)
├── scripts/
│   ├── index_docs.py
│   └── inspect_db.py        ← Day 3 新增
├── main.py                  (更新: Memory + Token 优化)
└── requirements.txt         (更新: langgraph-checkpoint-sqlite)
```

## 关键代码变更

### main.py
- 导入 `trim_messages`
- 添加 `MAX_MESSAGES` 配置和 `trim_message_history()` 函数
- `create_react_agent` 新增参数:
  - `checkpointer=memory`
  - `state_modifier=trim_message_history`
- invoke 调用传入 `config={"configurable": {"thread_id": thread_id}}`

### agent/memory/checkpointer.py
- `get_checkpointer()` 返回配置好的 `SqliteSaver`
- 自动创建 `data/db/` 目录
- 使用 `exist_ok=True` 避免重复创建错误

## 学到的东西

- LangGraph 的 `checkpointer` 参数实现持久化记忆
- `state_modifier` 可在每次 LLM 调用前修改状态，实现消息截断
- Windows 路径字符串需要注意转义（`\a` 被解释为响铃符）
- `os.path.join()` + `os.path.normpath()` 可跨平台处理路径

## 下一步

Phase 4 — 深入 Agent 图（手动构建 LangGraph 状态图，替换 `create_react_agent`）
